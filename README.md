ファイル構成
============

* README.md: おもいで
* nginx.conf: 動作確認に使ったnginxコンフィグ
* src/*: isucon4予選のWebアプリをnginxモジュールで実装した時のソースコード
* ringo/*: テンプレートファイル． /home/isucon/webapp/ の下に配置する必要がある


ISUCON4予選参加の思い出
=======================

はじめに
--------

昨年度も知人ら3人で参加し，散々な結果でしたが，
今年も懲りずに知人と参加してみました．

去年の敗因は
* みんなMySQLを知らなかった
* みんなmemcachedを詳しく知らなかった
* みんなWebアプリケーション周りの技術に詳しくなかった
* 朝に弱かった (でもお昼ごろには集まれたはず)

あたりかなぁと．
よくわからないものを使わないで全部作ればよかったね〜とか冗談で話していました．

今年は知人と参加しましたが，知人は諸般の事情で参加できる見込みが薄そうでした．


当日
----

事前準備も特にせずに当日を迎えました．
懸念事項だった朝起きられるかという問題も無事にクリアし10:30には起きたようです．
https://twitter.com/k_oi/status/516038870572355584

AWSを触るのは去年のISUCON以来一年ぶりとなるので少し手間取りましたが11時には
指示されたAMIを使ってインスタンスが起動できました．
https://twitter.com/k_oi/status/516044266808672256

昨年度はそもそもどうやってアプリケーションプロセスが起動しているかわからなかったのですが，
今年は去年の知見を活かして， /etc/supervisord.conf を編集して
いろんな言語の実装を動かしてみました．どれも性能に大きな差は無いみたいです．
大抵はDBボトルネックになるの気がするので，そんなもんなのかなぁと思いました．
nginxでTCP80番を受けて，TCP8080番で各アプリケーションプロセスのHTTPサーバとやりとりしているようでした．

ソースコードを見てみると，昨年度よりも規模が少なく，やっていることも簡単そうに見えました．
ここで昨年度の冗談が頭をよぎります．「よくわからないものを使わないで全部作ればよかったね〜」
今年は僕一人だけだし普通にやっても勝てな位と思うので，この規模なら行けるかも！と思い，
一から全部書き直そうと決めました．

ただ全部書きなおしてもつまらないので，今個人的に興味のある言語Rustを使って書きなおすか，
nginxのモジュールとして組み込んじゃうか悩みましたが，Rustは興味を持っているだけでまだ書けないので，
C言語で書かれているnginxのモジュールで行くことにしました．
nginxのモジュールを書いたことないけど，C言語は大学の授業で書いたのできっと何とかなると思ってました．
(この時点で13時ぐらい)

nginxのモジュールのサンプルを見てHello Worldして遊んでました．(13:30 ?)

とりあえず，最低限の実装ということで情報は全部メモリ上に乗せて，
トップページを表示させることを目標に書いてましたが…
C言語で文字列操作がツライとかいろいろ合ってなかなか進みません．
https://twitter.com/k_oi/status/516113038080876544

まぁ，間に合うわけ無いですよね．確か15:30の時点ではトップページの表示が出来たあたりだった気がします．

オンメモリに載せようにもテーブルを使おうと思ったらstd::mapとかないし，
アクセスログを配置しようにもstd::vectorとかないし...
https://twitter.com/k_oi/status/516114353351700480

仕方がないので全部固定長のバッファで実装を進めました．
(IPアドレスの範囲はきっと127.0.0.0/8の中だから2^24バイトとか少量だしね！)

なんとか，mypageまで表示させるところまでだどりつき，reportページも半分ぐらい出来ましたがタイムアップ...
一から書き直すという戦略はやっぱ無理が合ったようです．一回も結果を送信することが出来ないまま18時を迎えました．
https://twitter.com/k_oi/status/516153445145792512

とりあえず，全ページ表示させるところまで頑張ることにします．
https://twitter.com/k_oi/status/516169487884619776
なんとか全ページ表示させることが出来ましたが，ベンチマークツールの失敗数が4桁近く，バグ修正モード．

なんとか失敗の数が3桁になりましたが，workload=1で38000ぐらい，workload=4で55500ぐらい．
https://twitter.com/k_oi/status/516170683122868224
https://twitter.com/k_oi/status/516224415143456769

ここで諦めましたが，未だにテストに失敗する理由はわかっていません．
https://twitter.com/k_oi/status/516221001055494144

とても疲れました．


感想
----

C言語の各種ライブラリ(std::mapとかを簡単に実現するようなの)とか，
nginxモジュールの作り方とかを事前に調べておけば，時間内に出来た気がしますが，
今回は０点で終わりました．

やはり，この程度の規模でも作りなおしたりせずに，
プロファイルをとってきちんとボトルネックを解消していったほうがいいと思います(あたりまえ).

今回躓いたところや面倒だったところ
* C言語で文字列操作
* C言語でメモリ上に全データを管理するところ(ユーザテーブル，アクセスログテーブル...)
* nginxモジュール内でリクエストボディを読み取る方法
* nginxモジュール内でリクエストヘッダを読み取ったり，レスポンスヘッダに書き込むところ
* X-Forwarded-For !
